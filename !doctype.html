<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tour Booking OCR Extractor</title>

  <!-- OCR in browser -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      /* ‚úÖ Brand: White (main) + Navy (secondary) + Gold (accent) */
      --bg:#ffffff;
      --card:#ffffff;
      --line: rgba(11,31,59,.12);

      --navy:#0b1f3b;
      --navy-2:#12345f;
      --gold:#d4af37;

      --txt:#0f172a;
      --muted:#5b6b84;

      --shadow: 0 18px 55px rgba(11,31,59,.14);
      --shadow-2: 0 10px 28px rgba(11,31,59,.10);
      --radius: 22px;

      --focus: 0 0 0 4px rgba(212,175,55,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      color:var(--txt);
      background:
        /* subtle pattern */
        radial-gradient(900px 520px at 15% -10%, rgba(18,52,95,.10), transparent 62%),
        radial-gradient(820px 520px at 90% -6%, rgba(212,175,55,.12), transparent 60%),
        linear-gradient(135deg, rgba(11,31,59,.05), transparent 55%),
        var(--bg);
      position:relative;
      overflow-x:hidden;
    }

    /* Decorative background layers */
    body:before{
      content:"";
      position:fixed;
      inset:-200px;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(11,31,59,.035) 0px,
          rgba(11,31,59,.035) 10px,
          transparent 10px,
          transparent 26px
        );
      transform: rotate(-4deg);
      opacity:.35;
      z-index:0;
    }
    body:after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(600px 240px at 8% 18%, rgba(212,175,55,.10), transparent 60%),
        radial-gradient(520px 220px at 92% 16%, rgba(18,52,95,.09), transparent 60%);
      z-index:0;
    }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:26px;
      position:relative;
      z-index:1;
    }

    .header{
      display:flex;
      gap:16px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
      padding:18px 18px 14px;
      border-radius: 22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border:1px solid rgba(11,31,59,.10);
      box-shadow: var(--shadow-2);
      position:relative;
      overflow:hidden;
    }
    .header:before{
      content:"";
      position:absolute;
      inset:-80px -60px auto auto;
      width:320px;
      height:240px;
      background:
        radial-gradient(circle at 30% 30%, rgba(212,175,55,.18), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(18,52,95,.16), transparent 62%);
      transform: rotate(10deg);
      pointer-events:none;
      opacity:.85;
    }
    .header:after{
      content:"";
      position:absolute;
      inset:auto 0 0 0;
      height:3px;
      background: linear-gradient(90deg, rgba(18,52,95,.0), rgba(18,52,95,.9), rgba(212,175,55,.9), rgba(18,52,95,.0));
      pointer-events:none;
      opacity:.9;
    }

    .brand{display:flex;align-items:center;gap:12px}

    /* ‚úÖ Remove logo visually (keep HTML unchanged) */
    .logo{display:none !important;}
    .logo img{display:none !important;}

    /* ‚úÖ Make title super clear & bold */
    h1{
      margin:0;
      font-size:28px;
      line-height:1.1;
      letter-spacing:.3px;
      color:var(--navy);
      font-weight:1000;
      text-shadow: 0 1px 0 rgba(255,255,255,.85);
    }

    .badges{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(11,31,59,.12);
      color:var(--navy);
      font-size:12px;
      font-weight:900;
      box-shadow: 0 6px 16px rgba(11,31,59,.08);
      backdrop-filter: blur(6px);
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background: linear-gradient(135deg, var(--gold), #f2dd8a);
      box-shadow:0 0 0 4px rgba(212,175,55,.16), 0 8px 18px rgba(212,175,55,.20);
    }

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border: 1px solid rgba(11,31,59,.10);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      left:-60px;
      top:-70px;
      width:280px;
      height:220px;
      background:
        radial-gradient(circle at 30% 30%, rgba(212,175,55,.16), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(18,52,95,.14), transparent 62%);
      transform: rotate(-10deg);
      pointer-events:none;
      opacity:.7;
    }
    .card:after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: var(--radius);
      border:1px solid rgba(212,175,55,.18);
      pointer-events:none;
      opacity:.75;
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }

    .label{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      letter-spacing:.45px;
      text-transform:uppercase;
      color:rgba(11,31,59,.85);
      font-weight:1000;
    }
    .label .bar{
      width:12px;
      height:12px;
      border-radius:4px;
      background: linear-gradient(135deg, var(--navy), var(--navy-2));
      box-shadow: 0 10px 18px rgba(11,31,59,.16);
      position:relative;
    }
    .label .bar:after{
      content:"";
      position:absolute;
      inset:2px;
      border-radius:3px;
      background: linear-gradient(135deg, var(--gold), #f2dd8a);
      opacity:.95;
    }

    /* Drop zone */
    .drop{
      border:2px dashed rgba(18,52,95,.28);
      border-radius:18px;
      padding:18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88));
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:220px;
      text-align:center;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      outline:none;
      position:relative;
      overflow:hidden;
    }
    .drop:before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 30%, rgba(212,175,55,.10), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(18,52,95,.10), transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
      opacity:.9;
    }
    .drop:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(11,31,59,.12);
      border-color: rgba(212,175,55,.55);
    }
    .drop:focus{
      box-shadow: var(--focus), 0 18px 40px rgba(11,31,59,.12);
      border-color: rgba(212,175,55,.70);
    }
    .drop.dragover{
      background: rgba(212,175,55,.10);
      border-color: rgba(212,175,55,.85);
      box-shadow: 0 20px 44px rgba(212,175,55,.16);
      transform: translateY(-2px);
    }
    .drop-inner{
      max-width:540px;
      color:var(--muted);
      line-height:1.55;
      font-size:13px;
      position:relative;
      z-index:1;
    }
    .drop-title{
      color:var(--navy);
      font-weight:1000;
      font-size:16px;
      margin-bottom:8px;
    }

    .preview{
      width:100%;
      border:1px solid rgba(11,31,59,.12);
      border-radius:18px;
      background:#fff;
      overflow:hidden;
      margin-top:12px;
      display:none;
      box-shadow: 0 16px 36px rgba(11,31,59,.10);
    }
    .preview img{display:block;width:100%;height:auto}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Buttons: more depth */
    button{
      border:0;
      border-radius:16px;
      padding:11px 14px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
      transition: transform .08s ease, box-shadow .14s ease, opacity .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
    }
    button:active{transform:translateY(1px)}
    button:hover{transform: translateY(-1px)}
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none}

    .btn-primary{
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-2) 90%);
      color:#fff;
      border: 1px solid rgba(212,175,55,.40);
      box-shadow: 0 16px 30px rgba(11,31,59,.18);
    }
    .btn-primary:before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(240px 120px at 25% 20%, rgba(212,175,55,.22), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .btn-primary:hover{box-shadow: 0 20px 40px rgba(11,31,59,.22)}

    .btn-secondary{
      background: linear-gradient(180deg, #ffffff, rgba(18,52,95,.04));
      color:var(--navy);
      border:1px solid rgba(11,31,59,.14);
      box-shadow:0 12px 22px rgba(11,31,59,.10);
    }
    .btn-secondary:hover{
      box-shadow:0 16px 28px rgba(11,31,59,.12);
      border-color: rgba(212,175,55,.55);
    }

    .btn-ghost{
      background: rgba(255,255,255,.55);
      color:var(--navy);
      border:1px solid rgba(11,31,59,.18);
      box-shadow:0 10px 18px rgba(11,31,59,.08);
      backdrop-filter: blur(6px);
    }
    .btn-ghost:hover{
      border-color: rgba(212,175,55,.55);
      box-shadow:0 14px 24px rgba(11,31,59,.10);
    }

    .btn-danger{
      background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 16px 30px rgba(127,29,29,.16);
    }
    .btn-danger:hover{box-shadow: 0 20px 40px rgba(127,29,29,.20)}

    /* Status bar */
    .status{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-radius:16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(18,52,95,.03));
      border:1px solid rgba(11,31,59,.12);
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: 0 12px 22px rgba(11,31,59,.08);
    }
    .progress{
      flex:1;
      height:9px;
      border-radius:999px;
      background: rgba(11,31,59,.08);
      overflow:hidden;
      max-width:320px;
      border:1px solid rgba(11,31,59,.10);
    }
    .progress>div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--gold), rgba(212,175,55,.55));
      transition: width .15s ease;
    }

    /* Inputs */
    textarea, select, input[type="text"], input[type="date"]{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(11,31,59,.14);
      background: rgba(255,255,255,.95);
      padding:12px 12px;
      font-size:14px;
      line-height:1.55;
      outline:none;
      box-shadow: 0 10px 20px rgba(11,31,59,.06);
      transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    }
    textarea:hover, select:hover, input[type="text"]:hover, input[type="date"]:hover{
      border-color: rgba(212,175,55,.50);
      box-shadow: 0 14px 26px rgba(11,31,59,.08);
      transform: translateY(-1px);
    }
    textarea:focus, select:focus, input:focus{
      border-color: rgba(212,175,55,.75);
      box-shadow: var(--focus), 0 14px 30px rgba(11,31,59,.10);
      transform:none;
    }

    /* ‚úÖ dropdown text black (including options) */
    select{ color:#000; }
    option{ color:#000; }

    details summary{
      cursor:pointer;
      font-weight:1000;
      color:var(--navy);
      list-style:none;
      padding:8px 0;
    }
    details summary::-webkit-details-marker{display:none}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:rgba(11,31,59,.85);
      min-height:160px;
      background: rgba(255,255,255,.92);
    }

    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.5;
    }

    .control-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:14px;
      align-items:flex-end;
    }
    .control{flex:1;min-width:220px}
    .control .label{margin-bottom:8px}
    .inline-help{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.45;
    }

    .maps-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .maps-row input{flex:1;min-width:240px}

    /* Make output box feel ‚Äúpremium‚Äù */
    #output{
      background:
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(18,52,95,.02));
      border: 1px solid rgba(11,31,59,.14);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- ‚úÖ Put 001.png next to this html -->
          <img src="001.png" alt="Trips Chiang Mai Logo" onerror="this.style.display='none'">
        </div>
        <div>
          <!-- ‚úÖ Title only -->
          <h1>Tour Booking</h1>
        </div>
      </div>
      <div class="badges">
        <span class="pill"><span class="dot"></span>Viator + GetYourGuide</span>
        <span class="pill"><span class="dot"></span>Paste image (Ctrl+V)</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="section-title">
          <div class="label"><span class="bar"></span>Upload Booking Screenshot</div>
          <span class="pill"><span class="dot"></span>PNG/JPG</span>
        </div>

        <div id="drop" class="drop" tabindex="0">
          <div class="drop-inner">
            <div class="drop-title">‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
            <div>‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>Ctrl+V</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ</div>
            <small>‡∏ó‡∏¥‡∏õ: ‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô</small>
          </div>
          <input id="file" type="file" accept="image/*" style="display:none" />
        </div>

        <div class="preview" id="preview">
          <img id="previewImg" alt="preview" />
        </div>

        <div class="row">
          <button class="btn-primary" id="btnExtract" disabled>Extract From Image</button>
          <button class="btn-secondary" id="btnTips" type="button">Tips</button>
          <button class="btn-ghost" id="btnReset" type="button">Reset</button>
        </div>

        <div class="status" id="status">
          <span id="statusText">‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‚Ä¶</span>
          <div class="progress"><div id="bar"></div></div>
        </div>

        <details style="margin-top:10px">
          <summary>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (Debug)</summary>
          <textarea class="mono" id="ocrText" readonly style="margin-top:10px;"></textarea>
        </details>

        <div class="small">
          ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô: ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô / ‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô / ‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏õ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏≠‡∏Å
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="section-title">
          <div class="label"><span class="bar"></span>Output (Editable)</div>
          <span class="pill"><span class="dot"></span>Ready to send</span>
        </div>

        <textarea id="output" placeholder="Output ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å)" style="min-height:320px;"></textarea>

        <!-- Google Maps helper -->
        <div class="maps-row">
          <input id="hotelSearchQuery" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡πÉ‡∏ô Google Maps (‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° + ‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô My Mum Home Chiang Mai)" />
          <button class="btn-secondary" id="btnOpenMaps" type="button">Open Google Maps</button>
          <button class="btn-secondary" id="btnApplyMapLink" type="button" disabled>Apply Maps Link ‚Üí Output</button>
        </div>
        <div class="inline-help">
          ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡∏Å‡∏î Open Google Maps ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå maps.app.goo.gl ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Üí ‡∏Å‡∏î Apply
        </div>
        <div class="maps-row">
          <input id="mapLinkManual" type="text" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps (maps.app.goo.gl/...)" />
        </div>

        <!-- Booker + Booking Date + Pickup Time -->
        <div class="control-row">
          <div class="control">
            <div class="label"><span class="bar"></span>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</div>
            <select id="bookerSelect"></select>
            <div class="inline-help">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢)</div>
            <div class="control-row" style="margin-top:8px;">
              <div class="control" style="min-width:180px;">
                <input id="bookerNewName" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô Kan" />
              </div>
              <button class="btn-secondary" id="btnAddBooker" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
              <button class="btn-danger" id="btnRemoveBooker" type="button">‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
          </div>

          <div class="control">
            <div class="label"><span class="bar"></span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</div>
            <input id="bookedDateInput" type="date" />
            <div class="inline-help">Output ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</div>
          </div>
        </div>

        <!-- ‚úÖ Pickup Time selector + add/remove -->
        <div class="control-row">
          <div class="control">
            <div class="label"><span class="bar"></span>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö</div>
            <select id="pickupSelect"></select>
            <div class="inline-help">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</div>
            <div class="control-row" style="margin-top:8px;">
              <div class="control" style="min-width:180px;">
                <input id="pickupNewTime" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 07.30 - 08.00 AM." />
              </div>
              <button class="btn-secondary" id="btnAddPickup" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤</button>
              <button class="btn-danger" id="btnRemovePickup" type="button">‡∏•‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn-primary" id="btnCopy" disabled type="button">Copy Output</button>
          <button class="btn-secondary" id="btnCopyShort" disabled type="button">Copy (Short)</button>
        </div>

        <div class="small">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Output ‡∏à‡∏∞‡πÉ‡∏ä‡πâ ‚Äú‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‚Äù ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        </div>

        <!-- ‚úÖ Extracted Fields (‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡∏≤‡∏ß‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) -->
        <div id="fieldsSection" style="margin-top:14px; display:none;">
          <div class="label"><span class="bar"></span>Extracted Fields</div>
          <div class="small">‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</div>
        </div>

      </div>
    </div>
  </div>

<script>
/** =========================
 *  ‚úÖ SETTINGS
 *  ========================= */
const SHOW_EXTRACTED_FIELDS = false;

/** =========================
 *  1) MASTER (optional)
 *  ========================= */
const PROGRAM_MASTER = [
  {
    codeBase: "G-02",
    platform: "GetYourGuide",
    mainNames: [
      "Chiang Mai: Chiang Rai Temples, Golden Triangle & Boat Tour",
      "Chiang Rai Temples, Golden Triangle & Boat Tour"
    ],
    options: []
  },
  {
    codeBase: "V002",
    platform: "Viator",
    mainNames: [
      "Chiang Rai Secrets: Temples, Tribes & Golden Triangle",
      "Chiang Rai Secrets"
    ],
    options: []
  }
];

const $ = (id)=>document.getElementById(id);
let currentFile = null;
let lastFields = null;

/** =========================
 *  2) UTIL
 *  ========================= */
function setStatus(text, pct=0){
  $("statusText").textContent = text;
  $("bar").style.width = Math.max(0, Math.min(100, pct)) + "%";
}
function norm(s){ return (s||"").replace(/\s+/g," ").trim(); }
function cleanLeadingNoise(s){
  s = (s || "").trim();
  s = s.replace(/^(?:ey|ly|ty|uy|iy|vy)\b\s*/i, "");
  s = s.replace(/^[a-z]\b\s*/i, "");
  return s.trim();
}
function formatDateDMY(isoDate){
  if(!isoDate) return "";
  const [y,m,d] = isoDate.split("-");
  return `${d}/${m}/${y}`;
}
function normalizeName(name){ return (name||"").trim().replace(/\s+/g," "); }
function normalizePickup(s){
  return String(s||"").trim().replace(/\s+/g," ");
}
function isLikelyEmail(s){
  return /@/.test(s) || /reply\.getyourguide\.com/i.test(s) || /\bcustomer[-_]/i.test(s);
}
function looksLikePersonName(s){
  const t = String(s||"").trim();
  if(!t) return false;
  if(isLikelyEmail(t)) return false;
  if(t.length < 3) return false;
  if(/\b(reference|number|date|participants|pickup|price|language|tour)\b/i.test(t)) return false;
  if(/^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'‚Äô\-]+(\s+[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'‚Äô\-]+){0,4}$/.test(t)) return true;
  return false;
}

/** Label helpers */
function pickAfterLabelOrNextLine(text, labelRegex){
  const lines = (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  for(let i=0;i<lines.length;i++){
    const l = lines[i];
    if(labelRegex.test(l)){
      let val = l.replace(labelRegex, "").trim();
      if(!val && lines[i+1]) val = lines[i+1].trim();
      return val;
    }
  }
  return "";
}

/** =========================
 *  3) Platform detect
 *  ========================= */
function detectPlatform(text){
  const t = (text||"").toLowerCase();
  if (t.includes("viator")) return "Viator";
  if (t.includes("getyourguide") || t.includes("get your guide") || /\bgyg\b/i.test(text)) return "GetYourGuide";
  return "";
}

/** =========================
 *  4) Extractors (Viator + GYG)
 *  ========================= */
function extractProgramFull(text){
  const platform = detectPlatform(text);
  if(platform === "Viator"){
    const v = pickAfterLabelOrNextLine(text, /^Tour Name:\s*/i);
    return cleanLeadingNoise(v);
  }
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const candidates = lines
    .filter(l => l.length >= 18)
    .filter(l => /chiang\s+mai|chiang\s+rai|doi\s+inthanon|golden\s+triangle|temples|luang\s+prabang|slow\s+boat|transfer|trek/i.test(l));
  const pick = candidates.sort((a,b)=>b.length-a.length)[0] || "";
  return cleanLeadingNoise(pick);
}

function extractDate(text){
  const platform = detectPlatform(text);
  if(platform === "Viator"){
    return pickAfterLabelOrNextLine(text, /^Travel Date:\s*/i) || "";
  }
  let m = text.match(/\b(?:Mon|Tue|Tues|Wed|Thu|Thur|Fri|Sat|Sun)\s*,\s*[A-Za-z]{3,}\s+\d{1,2}\s*,\s*\d{4}\b/i);
  if(m) return m[0];
  m = text.match(/\b[A-Za-z]{3,}\s+\d{1,2}\s*,\s*\d{4}\b/);
  if(m) return m[0];
  m = text.match(/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/);
  if(m) return m[0];
  return "";
}

/** Main customer name */
function extractGuestName(text){
  const platform = detectPlatform(text);
  const raw = text || "";
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

  if(platform === "Viator"){
    return pickAfterLabelOrNextLine(raw, /^Lead Traveler Name:\s*/i) || "";
  }

  const idx = lines.findIndex(l => /main\s+customer/i.test(l));
  if(idx >= 0){
    const sameLine = lines[idx].replace(/.*main\s+customer\s*/i,"").trim();
    if(looksLikePersonName(sameLine)) return sameLine;

    for(let i=idx+1;i<Math.min(lines.length, idx+6);i++){
      const cand = lines[i];
      if(looksLikePersonName(cand)) return cand;
      const parts = cand.split(/\s{2,}|\s*\|\s*|\s*,\s*/).map(x=>x.trim()).filter(Boolean);
      for(const p of parts){
        if(looksLikePersonName(p)) return p;
      }
      if(isLikelyEmail(cand)) continue;
    }
  }
  const fallback = lines.find(l => looksLikePersonName(l));
  return fallback || "";
}

function extractPax(text){
  const platform = detectPlatform(text);
  if(platform === "Viator"){
    const v = pickAfterLabelOrNextLine(text, /^Travelers:\s*/i);
    const m = v.match(/(\d+)/);
    return m ? m[1] : "";
  }
  let m = text.match(/\b(\d+)\s*x\s*Adults?\b/i);
  if(m) return m[1];
  m = text.match(/\b(\d+)\s*(?:pax|people|persons|participants)\b/i);
  if(m) return m[1];
  m = text.match(/\bTravelers?:\s*(\d+)\b/i);
  if(m) return m[1];
  return "";
}

function extractHotel(text){
  const platform = detectPlatform(text);
  const raw = text || "";
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

  if(platform === "Viator"){
    const hotelLine =
      pickAfterLabelOrNextLine(raw, /^Hotel\s*Pick\s*up\s*:?\s*/i) ||
      pickAfterLabelOrNextLine(raw, /^Hotel\s*Pickup\s*:?\s*/i);

    if(hotelLine){
      const first = hotelLine.split(",")[0].trim();
      return first || "";
    }
    for(let i=0;i<lines.length;i++){
      if(/hotel/i.test(lines[i]) && /pick/i.test(lines[i])){
        const next = lines[i+1] || "";
        const first = next.split(",")[0].trim();
        if(first) return first;
      }
    }
    return "";
  }

  for(const l of lines){
    if(/pickup/i.test(l)){
      let s = l.replace(/.*pickup\s*:?\s*/i, "");
      s = s.replace(/open in google maps.*/i, "").trim();
      const first = s.split(",")[0].trim();
      if(first && first.length >= 2) return first;
    }
  }
  const pIdx = lines.findIndex(l => /^pickup\b/i.test(l) || /\bpickup\b/i.test(l));
  if(pIdx >= 0){
    const next = lines.slice(pIdx+1).find(l => l && !/open in google maps/i.test(l));
    if(next){
      const first = next.split(",")[0].trim();
      if(first && first.length >= 2) return first;
    }
  }
  const hit = lines.find(l => /hotel|hostel|resort|guesthouse|guest house|inn/i.test(l));
  if(hit){
    const first = hit.split(",")[0].trim();
    if(first && first.length >= 2) return first;
  }
  return "";
}

function extractMapLink(text){
  const m = text.match(/https?:\/\/(maps\.app\.goo\.gl|goo\.gl\/maps|www\.google\.com\/maps)[^\s)]+/i);
  return m ? m[0] : "";
}

function extractPhone(text){
  const platform = detectPlatform(text);
  if(platform === "Viator"){
    const v = pickAfterLabelOrNextLine(text, /^Phone:\s*/i);
    if(v){
      const m = v.match(/(\+?\d[\d\s\-()]{6,}\d)/);
      return m ? m[1].replace(/\s+/g," ").trim() : "";
    }
  }
  const m = text.match(/(\+?\d[\d\s\-()]{7,}\d)/);
  return m ? m[1].replace(/\s+/g," ").trim() : "";
}

function extractVoucherPlatform(text){
  const p = detectPlatform(text);
  if(p === "GetYourGuide") return "E- Voucher ‡∏Ç‡∏≠‡∏á Get Your Guide";
  if(p === "Viator") return "E- Voucher ‡∏Ç‡∏≠‡∏á Viator";
  return "E- Voucher";
}
function extractPaymentStatus(text){
  const t = (text||"").toLowerCase();
  if(t.includes("paid in full") || t.includes("paid")) return "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞";
  if(t.includes("deposit")) return "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞";
  if(t.includes("unpaid")) return "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏∞";
  return "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞";
}

/** ‚úÖ Options: ONLY show Excl. Long Neck = ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏¢‡∏≤‡∏ß (if detected) */
function detectOptionExclLongNeckOnly(text){
  const raw = String(text||"");
  const hasExclLongNeck = /excl\.?\s*long\s*neck|excluding\s+long\s+neck|without\s+long\s+neck/i.test(raw);
  if(!hasExclLongNeck) return { optionEN:"", optionTH:"" };
  return { optionEN:"Excl. Long Neck", optionTH:"‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏¢‡∏≤‡∏ß" };
}

/** Viator: Tour Grade parsing (ex: "A ‚Äì Incl. Long Neck") */
function extractViatorTourGrade(text){
  const raw = String(text||"");
  const v = pickAfterLabelOrNextLine(raw, /^Tour Grade:\s*/i);
  return v || "";
}

/** =========================
 *  5) Pickup Times (persistent)
 *  ========================= */
const PICKUP_STORAGE_KEY = "booking_extractor_pickups_v1";
const DEFAULT_PICKUPS = ["07.00 - 07.30 AM."];

function loadPickups(){
  try{
    const raw = localStorage.getItem(PICKUP_STORAGE_KEY);
    if(!raw) return [...DEFAULT_PICKUPS];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length===0) return [...DEFAULT_PICKUPS];
    return arr.map(x=>String(x)).filter(Boolean);
  }catch{
    return [...DEFAULT_PICKUPS];
  }
}
function savePickups(arr){ localStorage.setItem(PICKUP_STORAGE_KEY, JSON.stringify(arr)); }

function refreshPickupSelect(prefer){
  const sel = $("pickupSelect");
  const list = loadPickups();
  sel.innerHTML = "";
  for(const t of list){
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  }
  const pick = (prefer && list.includes(prefer)) ? prefer : (list[0] || DEFAULT_PICKUPS[0]);
  sel.value = pick;
}
function getPickupTime(){
  return ($("pickupSelect")?.value || DEFAULT_PICKUPS[0]);
}

/** =========================
 *  6) Output
 *  ========================= */
function buildCompanyOutput(fields){
  const programLine = fields.programFull || "";

  const bookerName = ($("bookerSelect")?.value || "Tam");
  const bookerPhone = "0622895343";

  const bookedDateISO = ($("bookedDateInput")?.value || "");
  const bookedDateText = bookedDateISO ? formatDateDMY(bookedDateISO) : "";

  const hotelBlock = fields.mapLink
    ? `${fields.hotelName || ""}\n${fields.mapLink}`
    : `${fields.hotelName || ""}\n(‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Map Link ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Apply)`;

  const pickupTime = getPickupTime();

  const optionDisplay = fields.optionEN
    ? ` (${fields.optionEN} = ${fields.optionTH})`
    : "";

  return `‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Ñ‡πà‡∏∞

üìå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á : ${fields.travelDate || ""}

üìå‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° : ${programLine}${optionDisplay}${fields.extraNote ? " " + fields.extraNote : ""}

üìå‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ : ${fields.guestName || ""}

üìå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${fields.pax || ""}

üìå‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö: ${pickupTime}

üìå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° : ${hotelBlock}

üìå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: -

üìå ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${fields.phone || ""}

üö©‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ : ${fields.voucher || "E- Voucher"} ${fields.paymentStatus || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞"}

(‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ Voucher ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ)

‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á : ${bookerName} (${bookerPhone})         ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á  ${bookedDateText}`;
}

function buildShortOutput(fields){
  return `‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Ñ‡πà‡∏∞
üìå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á : ${fields.travelDate || ""}
üìå‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° : ${fields.programFull || ""}${fields.optionEN ? " ("+fields.optionEN+" = "+fields.optionTH+")" : ""}
üìå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ : ${fields.guestName || ""}
üìå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : ${fields.pax || ""}
üìå‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° : ${fields.hotelName || ""}`;
}

/** =========================
 *  7) Extract all
 *  ========================= */
function extractAllFromText(ocrText){
  const raw = ocrText || "";
  const platform = detectPlatform(raw);

  const programFull = norm(extractProgramFull(raw));
  const travelDate  = extractDate(raw);
  const guestName   = extractGuestName(raw);
  const pax         = extractPax(raw);
  const hotelName   = extractHotel(raw);
  const mapLink     = extractMapLink(raw);
  const phone       = extractPhone(raw);
  const voucher     = extractVoucherPlatform(raw);
  const paymentStatus = extractPaymentStatus(raw);

  // ‚úÖ Only Excl. Long Neck mapping (if detected)
  // Viator: Tour Grade often contains Incl/Excl Long Neck
  const viatorGrade = (platform === "Viator") ? extractViatorTourGrade(raw) : "";
  const opt = detectOptionExclLongNeckOnly(raw + "\n" + viatorGrade);

  return {
    platform,
    programFull,
    optionEN: opt.optionEN,
    optionTH: opt.optionTH,
    travelDate,
    guestName,
    pax,
    hotelName,
    mapLink,
    phone,
    voucher,
    paymentStatus,
    extraNote: ""
  };
}

/** =========================
 *  8) OCR
 *  ========================= */
async function runOCR(file){
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° OCR‚Ä¶", 6);

  const result = await Tesseract.recognize(
    file,
    "eng",
    {
      logger: (m)=>{
        const pct = m.progress ? Math.round(m.progress * 100) : 0;
        if(m.status === "loading tesseract core") setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î OCR engine‚Ä¶", 5);
        if(m.status === "loading language traineddata") setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏≤‚Ä¶", 8);
        if(m.status === "recognizing text") setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‚Ä¶", Math.max(10, pct));
      }
    }
  );
  return (result?.data?.text || "").trim();
}

/** =========================
 *  9) Bookers add/remove (persistent)
 *  ========================= */
const BOOKER_STORAGE_KEY = "booking_extractor_bookers_v1";
const DEFAULT_BOOKERS = ["Fay","Ploy","Mon","Plam","Tam"];

function loadBookers(){
  try{
    const raw = localStorage.getItem(BOOKER_STORAGE_KEY);
    if(!raw) return [...DEFAULT_BOOKERS];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length===0) return [...DEFAULT_BOOKERS];
    return arr.map(x=>String(x)).filter(Boolean);
  }catch{
    return [...DEFAULT_BOOKERS];
  }
}
function saveBookers(arr){ localStorage.setItem(BOOKER_STORAGE_KEY, JSON.stringify(arr)); }

function refreshBookerSelect(preferName){
  const sel = $("bookerSelect");
  const list = loadBookers();
  sel.innerHTML = "";
  for(const name of list){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  }
  const pick = preferName && list.includes(preferName) ? preferName : (list.includes("Tam") ? "Tam" : list[0]);
  sel.value = pick;
}

/** =========================
 *  10) UI (Upload / Drag / Paste)
 *  ========================= */
const drop = $("drop");
const file = $("file");

drop.addEventListener("click", ()=> file.click());
drop.addEventListener("dragover", (e)=>{ e.preventDefault(); drop.classList.add("dragover"); });
drop.addEventListener("dragleave", ()=> drop.classList.remove("dragover"));
drop.addEventListener("drop", (e)=>{
  e.preventDefault();
  drop.classList.remove("dragover");
  const f = e.dataTransfer.files?.[0];
  if(f) loadFile(f);
});
file.addEventListener("change", ()=>{
  const f = file.files?.[0];
  if(f) loadFile(f);
});

function loadFile(f){
  if(!f.type.startsWith("image/")){
    setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (PNG/JPG)", 0);
    return;
  }
  currentFile = f;

  const imgURL = URL.createObjectURL(f);
  $("previewImg").src = imgURL;
  $("preview").style.display = "block";

  $("ocrText").value = "";
  $("output").value = "";
  $("btnCopy").disabled = true;
  $("btnCopyShort").disabled = true;

  $("btnExtract").disabled = false;
  setStatus(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß: ${f.name}`, 0);
}

function refreshOutputIfReady(){
  if(!lastFields) return;
  $("output").value = buildCompanyOutput(lastFields);
}

/* ‚úÖ Paste image (Ctrl+V / right-click paste if allowed) */
drop.addEventListener("mousedown", () => drop.focus());
drop.addEventListener("paste", handlePasteImage);
document.addEventListener("paste", handlePasteImage);

function handlePasteImage(e){
  try{
    const items = e.clipboardData?.items;
    if(!items || !items.length) return;

    let imageItem = null;
    for(const it of items){
      if(it.type && it.type.startsWith("image/")){
        imageItem = it; break;
      }
    }
    if(!imageItem) return;

    e.preventDefault();
    const blob = imageItem.getAsFile();
    if(!blob) return;

    const ext = (blob.type.split("/")[1] || "png").toLowerCase();
    const pastedFile = new File([blob], `pasted_${Date.now()}.${ext}`, { type: blob.type });

    loadFile(pastedFile);
    setStatus("‚úÖ ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß", 0);
  }catch(err){
    console.error(err);
    setStatus("‚ùå ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á Ctrl+V ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ó‡∏ô", 0);
  }
}

$("btnExtract").addEventListener("click", async ()=>{
  if(!currentFile) return;

  try{
    $("btnExtract").disabled = true;
    $("btnCopy").disabled = true;
    $("btnCopyShort").disabled = true;
    $("output").value = "";

    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‚Ä¶", 2);
    const text = await runOCR(currentFile);
    $("ocrText").value = text;

    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶", 92);
    const fields = extractAllFromText(text);
    lastFields = fields;

    $("hotelSearchQuery").value = fields.hotelName ? `${fields.hotelName} Chiang Mai` : "";
    $("mapLinkManual").value = fields.mapLink || "";
    $("btnApplyMapLink").disabled = !($("mapLinkManual").value || "").trim();

    $("output").value = buildCompanyOutput(fields);

    $("btnCopy").disabled = false;
    $("btnCopyShort").disabled = false;

    setStatus("‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Output ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å)", 100);

  } catch(err){
    console.error(err);
    setStatus("‚ùå OCR ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô / ‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", 0);
  } finally{
    $("btnExtract").disabled = false;
  }
});

$("btnReset").addEventListener("click", ()=>{
  currentFile = null;
  lastFields = null;
  file.value = "";
  $("preview").style.display = "none";
  $("previewImg").src = "";
  $("ocrText").value = "";
  $("output").value = "";
  $("btnExtract").disabled = true;
  $("btnCopy").disabled = true;
  $("btnCopyShort").disabled = true;

  $("hotelSearchQuery").value = "";
  $("mapLinkManual").value = "";
  $("btnApplyMapLink").disabled = true;

  setStatus("‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‚Ä¶", 0);
});

$("btnTips").addEventListener("click", ()=>{
  alert("‡∏ó‡∏¥‡∏õ‡πÉ‡∏´‡πâ OCR ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô:\n- ‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ\n- ‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏õ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏≠‡∏≠‡∏Å\n- ‡∏£‡∏π‡∏õ‡∏Ñ‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏•‡∏≠\n- ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡∏•‡∏≠‡∏á‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• booking\n\nTip: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ");
});

async function copyText(text){ await navigator.clipboard.writeText(text); }

$("btnCopy").addEventListener("click", async ()=>{
  const out = $("output").value || "";
  if(!out.trim()) return;
  try{ await copyText(out); setStatus("üìã Copy Output ‡πÅ‡∏•‡πâ‡∏ß", 100); }
  catch(e){ setStatus("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á Ctrl+C", 100); }
});

$("btnCopyShort").addEventListener("click", async ()=>{
  if(!lastFields) return;
  const shortOut = buildShortOutput(lastFields);
  try{ await copyText(shortOut); setStatus("üìã Copy (Short) ‡πÅ‡∏•‡πâ‡∏ß", 100); }
  catch(e){ setStatus("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á Ctrl+C", 100); }
});

/** Bookers add/remove */
$("btnAddBooker").addEventListener("click", ()=>{
  const name = normalizeName($("bookerNewName").value);
  if(!name) return;

  const list = loadBookers();
  if(list.some(x => x.toLowerCase() === name.toLowerCase())){
    setStatus("‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", 100);
    $("bookerNewName").value = "";
    return;
  }
  list.push(name);
  saveBookers(list);
  refreshBookerSelect(name);
  $("bookerNewName").value = "";
  setStatus(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${name}`, 100);
  refreshOutputIfReady();
});

$("btnRemoveBooker").addEventListener("click", ()=>{
  const sel = $("bookerSelect");
  const name = sel.value;
  const list = loadBookers();

  if(list.length <= 1){
    setStatus("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏∑‡πà‡∏≠", 100);
    return;
  }
  const ok = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`);
  if(!ok) return;

  const newList = list.filter(x => x !== name);
  saveBookers(newList);
  refreshBookerSelect(newList.includes("Tam") ? "Tam" : newList[0]);
  setStatus(`üóëÔ∏è ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${name}`, 100);
  refreshOutputIfReady();
});

$("bookerSelect").addEventListener("change", refreshOutputIfReady);
$("bookedDateInput").addEventListener("change", refreshOutputIfReady);

/** Pickup add/remove */
$("btnAddPickup").addEventListener("click", ()=>{
  const t = normalizePickup($("pickupNewTime").value);
  if(!t) return;

  const list = loadPickups();
  if(list.some(x => x.toLowerCase() === t.toLowerCase())){
    setStatus("‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", 100);
    $("pickupNewTime").value = "";
    return;
  }
  list.push(t);
  savePickups(list);
  refreshPickupSelect(t);
  $("pickupNewTime").value = "";
  setStatus(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö: ${t}`, 100);
  refreshOutputIfReady();
});

$("btnRemovePickup").addEventListener("click", ()=>{
  const sel = $("pickupSelect");
  const t = sel.value;
  const list = loadPickups();

  if(list.length <= 1){
    setStatus("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏ß‡∏•‡∏≤", 100);
    return;
  }
  const ok = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ "${t}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`);
  if(!ok) return;

  const newList = list.filter(x => x !== t);
  savePickups(newList);
  refreshPickupSelect(newList[0]);
  setStatus(`üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö: ${t}`, 100);
  refreshOutputIfReady();
});
$("pickupSelect").addEventListener("change", refreshOutputIfReady);

/** Google Maps helper */
$("btnOpenMaps").addEventListener("click", ()=>{
  const q = ($("hotelSearchQuery").value || "").trim();
  if(!q){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô My Mum Home Chiang Mai");
    return;
  }
  const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q);
  window.open(url, "_blank");
});

$("mapLinkManual").addEventListener("input", ()=>{
  $("btnApplyMapLink").disabled = !($("mapLinkManual").value || "").trim();
});

$("btnApplyMapLink").addEventListener("click", ()=>{
  if(!lastFields){
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å OCR ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Extract ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const link = ($("mapLinkManual").value || "").trim();
  if(!link){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  lastFields.mapLink = link;
  $("output").value = buildCompanyOutput(lastFields);
  setStatus("‚úÖ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡πÄ‡∏Ç‡πâ‡∏≤ Output ‡πÅ‡∏•‡πâ‡∏ß", 100);
});

/** init defaults */
(function initDefaults(){
  refreshBookerSelect("Tam");

  // ‚úÖ today as default booking date (auto changes each day when you open the page)
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  $("bookedDateInput").value = `${yyyy}-${mm}-${dd}`;

  // ‚úÖ pickup list
  refreshPickupSelect(DEFAULT_PICKUPS[0]);

  // ‚úÖ hide extracted fields
  $("fieldsSection").style.display = SHOW_EXTRACTED_FIELDS ? "block" : "none";

  setStatus("‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‚Ä¶", 0);
})();
</script>
</body>
</html>
